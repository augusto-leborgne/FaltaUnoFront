name: Deploy Frontend to Cloud Run

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  GCP_PROJECT_ID: master-might-274420
  GCP_REGION: us-central1
  SERVICE_NAME: faltauno-frontend

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/169771742214/locations/global/workloadIdentityPools/github-pool/providers/frontend-provider'
          service_account: 'deploy-cicd@master-might-274420.iam.gserviceaccount.com'
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
      
      - name: Configure Docker for GCP
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev
      
      - name: Build with Cloud Build
        run: |
          # Backend URL - ACTUALIZADO para Cloud Run
          BACKEND_URL="https://faltauno-backend-169771742214.us-central1.run.app"
          
          # Generate commit SHA
          COMMIT_SHA=${{ github.sha }}
          SHORT_SHA=$(echo $COMMIT_SHA | cut -c1-7)
          echo "Building frontend with commit: $SHORT_SHA"

          # Build using Cloud Build (async para evitar timeout por logs)
          BUILD_ID=$(gcloud builds submit \
            --config=cloudbuild-prod.yaml \
            --project=${{ env.GCP_PROJECT_ID }} \
            --substitutions="SHORT_SHA=$SHORT_SHA,_NEXT_PUBLIC_API_URL=$BACKEND_URL" \
            --async \
            --format="value(id)")
          
          echo "Build ID: $BUILD_ID"
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          
          # Wait for build to complete
          echo "Waiting for build to complete..."
          while true; do
            STATUS=$(gcloud builds describe $BUILD_ID --project=${{ env.GCP_PROJECT_ID }} --format="value(status)" 2>/dev/null || echo "UNKNOWN")
            echo "Build status: $STATUS"
            
            if [ "$STATUS" = "SUCCESS" ]; then
              echo "âœ… Build completed successfully!"
              break
            elif [ "$STATUS" = "FAILURE" ] || [ "$STATUS" = "TIMEOUT" ] || [ "$STATUS" = "CANCELLED" ]; then
              echo "âŒ Build failed with status: $STATUS"
              exit 1
            fi
            
            sleep 10
          done
          
          echo "âœ… Image built: us-central1-docker.pkg.dev/master-might-274420/cloud-run-source-deploy/faltauno-frontend:${SHORT_SHA}-prod"
      
      - name: Deploy to Cloud Run
        run: |
          COMMIT_SHA=${{ github.sha }}
          SHORT_SHA=$(echo $COMMIT_SHA | cut -c1-7)
          BACKEND_URL="https://faltauno-backend-169771742214.us-central1.run.app"
          
          # Deploy usando la imagen construida con Cloud Build
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image us-central1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/cloud-run-source-deploy/${{ env.SERVICE_NAME }}:${SHORT_SHA}-prod \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10 \
            --port 8080 \
            --tag "sha-$SHORT_SHA" \
            --project ${{ env.GCP_PROJECT_ID }} \
            --quiet
          
          echo "âœ… Deployment completed"
      
      - name: Migrate Traffic to New Revision
        run: |
          # Get the new revision name
          NEW_REVISION=$(gcloud run revisions list \
            --service ${{ env.SERVICE_NAME }} \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --format 'value(name)' \
            --sort-by='~metadata.creationTimestamp' \
            --limit 1 \
            --project ${{ env.GCP_PROJECT_ID }})
          
          echo "Migrating 100% traffic to: $NEW_REVISION"
          
          # Route 100% traffic to new revision (zero downtime cutover)
          gcloud run services update-traffic ${{ env.SERVICE_NAME }} \
            --to-revisions=$NEW_REVISION=100 \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --project ${{ env.GCP_PROJECT_ID }}
          
          echo "âœ… Traffic migrated successfully"
      
      - name: Get Service URL
        id: get-url
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --format 'value(status.url)')
          echo "Frontend URL: $URL"
          echo "url=$URL" >> $GITHUB_OUTPUT
      
      - name: Verify deployment
        run: |
          sleep 20
          curl -f ${{ steps.get-url.outputs.url }}/api/health || echo "âš ï¸ Health check failed, but deployment completed"
      
      - name: Deployment summary
        run: |
          echo "ğŸ‰ Frontend deployed successfully!"
          echo "URL: ${{ steps.get-url.outputs.url }}"
